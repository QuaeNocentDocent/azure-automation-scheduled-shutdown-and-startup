{
    "$schema": "http://schemas.microsoft.org/azure/deploymentTemplate?api-version=2015-01-01-preview#",
    "contentVersion": "1.0",
    "parameters": {
        "omsAutomationAccountName": {
            "type": "string",
            "metadata": {
                "description": "Use an existing Automation account or create a new one."
            }
        },
    "omsAutomationRegion": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "westeurope",
        "southeastasia",
        "eastus2",
        "southcentralus",
        "japaneast"
      ],
      "metadata": {
        "description": "Specify the Azure Region for your OMS Automation Account"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/QuaeNocentDocent/azure-automation-scheduled-shutdown-and-startup/30andswitch",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located"
      }
    }        
    },
    "variables": {
        "runbooks": [
          {
            "name": "Test-VMStartStopSchedule",
            "description": "Lists every VM on every resource group of a subscription and test for a Schedule tag existance and takes an action to start or shutdown the VM depending on scheduled hours.",
            "type": "Script",
            "logProgress": "false",
            "logVerbose": "false",
            "Id":"",
            "publishContentLink": {
              "uri": "[concat(parameters('_artifactsLocation'),'/Runbooks/Test-ResourceSchedule.ps1')]",
              "version": "1.0.0.0"
            }
          }
        ],
        // to be converted in array
        "scheduleName": "Hourly",
        "jobScheduleName": "StartStop-Hourly"
    },
    "resources": [
      {
        "name": "[parameters('omsAutomationAccountName')]",
        "type": "Microsoft.Automation/automationAccounts",
        "apiVersion": "2015-10-31",
        "location": "[parameters('omsAutomationRegion')]",
        "dependsOn": [ ],
        "tags": { },
        "properties": {
          "sku": {
            "name": "Basic"
          }
        }
      },
      {
        "name": "[concat(parameters('omsAutomationAccountName'),'/',variables('runbooks')[copyIndex()].name)]",
        "type": "Microsoft.Automation/automationAccounts/runbooks",
        "apiVersion": "2015-10-31",
        "location": "[parameters('omsAutomationRegion')]",        
        "copy": {
            "name": "runbooksCopy",
            "count": "[length(variables('runbooks'))]"
        },
        "dependsOn": [
            "[resourceId('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
        ],
        "properties": {
              "runbookType": "[variables('runbooks')[copyIndex()].type]",
              "logProgress": "[variables('runbooks')[copyIndex()].logProgress]",
              "logVerbose": "[variables('runbooks')[copyIndex()].logVerbose]",
              "description": "[variables('runbooks')[copyIndex()].description]",
              "publishContentLink": "[variables('runbooks')[copyIndex()].publishContentLink]"
        }
      },
      {
        "name": "[concat(parameters('omsAutomationAccountName'),'/',variables('scheduleName'))]",
        "type": "Microsoft.Automation/automationAccounts/schedules",
        "apiVersion": "2015-10-31",
        "location": "[parameters('omsAutomationRegion')]",          
        "properties": {
            "description": "",
            "startTime": "",
            "expiryTime": "9999-12-31T23:59:59.9999999+00:00",
            "isEnabled": true,
            "interval": 1,
            "frequency": "Hour"
        },
        "dependsOn": [
            "[resourceId('Microsoft.Automation/automationAccounts', parameters('omsAutomationAccountName'))]"
        ]
      },
      {
        "type": "Microsoft.Automation/automationAccounts/jobSchedules",
        "name": "[concat(parameters('omsAutomationAccountName'),'/',variables('jobScheduleName'))]",
        "apiVersion": "2015-10-31",
        "location": "[parameters('omsAutomationRegion')]",        
        "properties": {
            "runbook": {
                "name": "Test-VMStartStopSchedule"
            },
            "schedule": {
                "name": "[variables('scheduleName')]"
            },
            "parameters": null
        },
        "dependsOn": [
              "[resourceId('Microsoft.Automation/automationAccounts', parameters('omsAutomationAccountName'))]",
              "[resourceId('Microsoft.Automation/automationAccounts/schedules', parameters('omsAutomationAccountName'), variables('scheduleName'))]",
              "runbooksCopy"              
        ]
      }      
    ],
    "outputs": {}
}